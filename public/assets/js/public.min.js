document.addEventListener("DOMContentLoaded",function(e){const r=document.getElementById("statsReservationsCount"),s=(r&&fetch("/api/statistics").then(e=>e.json()).then(e=>{r.innerHTML=`(${e.counters.reservations_upcoming})`}),document.getElementById("reserveSlot")),l=document.getElementById("reserveSlotForm"),n=(s&&s.addEventListener("show.bs.modal",e=>{e=e.relatedTarget;const r=s.querySelector("#reserveSlotSubmitButton");e=e.getAttribute("data-bs-slot-id");r.disabled=!0,s.querySelector("div.modal-body.loading-spinner").style.display="block",s.querySelector("div.modal-body.loaded-content").style.display="none",fetch("/api/slot/"+e).then(e=>e.json()).then(e=>{!1===e.success?(s.querySelector("#reserveSlotError div.alert span").innerText=e.message,s.querySelector("div.modal-body.loading-spinner").style.display="none",s.querySelector("div.modal-body.loaded-content").style.display="block",s.querySelector("#reserveSlotError").style.display="block"):(s.querySelector("#r_slot_id").value=e.id,s.querySelector("#r_type").value=e.type,s.querySelector("#r_message").value="",s.querySelector("#r_course_name").innerText=e.course_name,s.querySelector("#r_instructor_name").innerText=e.instructor_name,s.querySelector("#r_location_name").innerText=e.location_name,s.querySelector("#r_slot_time").innerText=e.time_human_readable_sv,!1===e.course_message_required&&s.querySelector("#r_message").removeAttribute("required"),""!==e.course_description&&(s.querySelector("#r_course_description").innerText=e.course_description,s.querySelector("#r_course_description").classList.remove("d-none")),"individual"===e.type?(s.querySelector("#reserveSlotGroupConnectNotice").style.display="none",s.querySelector("#reserveSlotGroupNotice").style.display="none",s.querySelector("#reserveSlotIndividualBlock").style.display="block",s.querySelector("#reserveSlotGroupBlock").style.display="none",s.querySelector("#reserveSlotUserNotInGroup").style.display="none",r.disabled=!1):(s.querySelector("#reserveSlotIndividualBlock").style.display="none",s.querySelector("#reserveSlotGroupBlock").style.display="block",""==s.querySelector("#r_group_string").value?s.querySelector("#reserveSlotUserNotInGroup").style.display="block":(s.querySelector("#reservations").replaceChildren(),e.reservations&&0<e.reservations.length?(e.reservations.forEach(e=>{s.querySelector("#reservations").appendChild(document.createElement("div")).innerText=e.canvas_group_name}),e.res_now==e.res_max-1&&e.course_message_all_when_full?(s.querySelector("#reserveSlotGroupConnectNotice").style.display="block",s.querySelector("#reserveSlotGroupNotice").style.display="none"):(s.querySelector("#reserveSlotGroupConnectNotice").style.display="none",s.querySelector("#reserveSlotGroupNotice").style.display="block"),s.querySelector("#reservationsContainer").style.display="block"):(s.querySelector("#reserveSlotGroupConnectNotice").style.display="none",s.querySelector("#reserveSlotGroupNotice").style.display="block",s.querySelector("#reservationsContainer").style.display="none"),r.disabled=!1)),s.querySelector("div.modal-body.loading-spinner").style.display="none",s.querySelector("div.modal-body.loaded-content").style.display="block",s.querySelector("#reserveSlotError").style.display="none")}).catch(e=>{s.querySelector("div.modal-body.loading-spinner").style.display="none",s.querySelector("div.modal-body.loaded-content").style.display="none",s.querySelector("div.modal-body.loading-error").style.display="block"})}),l&&l.addEventListener("submit",function(e){if(l.checkValidity()){l.classList.add("was-validated");var r={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slot_id:s.querySelector("#r_slot_id").value,group_id:s.querySelector("#r_group_id").value,user_id:s.querySelector("#r_user_id").value,message:s.querySelector("#r_message").value})};const t=s.querySelector("#reserveSlotSubmitButton"),o=t.querySelector("span.spinner-border");t.disabled=!0,o.style.display="inline-block",fetch("/api/reservation",r).then(e=>e.text()).then(e=>{var r=JSON.parse(e);!1===r.success?(s.querySelector("#reserveSlotError .alert span").innerText=JSON.parse(e).message,s.querySelector("#reserveSlotError").classList.remove("d-none"),s.querySelector("#reserveSlotError").classList.add("d-block"),t.disabled=!1):window.location.assign("/reservations?reservationDone=true"+("group"==s.querySelector("#r_type").value?"&reservationGroup=true":"")+"&reservationId="+r.reservation_id),o.classList.remove("d-inline-block"),o.classList.add("d-none")}).catch(e=>{s.querySelector("#reserveSlotError .alert span").innerText=e,s.querySelector("#reserveSlotError").classList.remove("d-none"),s.querySelector("#reserveSlotError").classList.add("d-block"),t.disabled=!1,o.classList.remove("d-inline-block"),o.classList.add("d-none")})}else e.preventDefault(),e.stopPropagation(),l.classList.add("was-validated");e.preventDefault(),e.stopPropagation()}),document.getElementById("deleteReservation"));var t=document.getElementById("deleteReservationForm");n&&n.addEventListener("show.bs.modal",e=>{e=e.relatedTarget.getAttribute("data-bs-reservation-id");const r=n.querySelector("#deleteReservationSubmitButton");n.querySelector("#deleteReservationWarning").classList.contains("d-block")&&(n.querySelector("#deleteReservationWarning").classList.remove("d-block"),n.querySelector("#deleteReservationWarning").classList.add("d-none")),n.querySelector("#deleteReservationError").classList.contains("d-block")&&(n.querySelector("#deleteReservationError").classList.remove("d-block"),n.querySelector("#deleteReservationError").classList.add("d-none")),fetch("/api/reservation/"+e).then(e=>e.json()).then(e=>{n.querySelector("#d_reservation_id").value=e.id,n.querySelector("#d_reservation_type").value=e.is_group?"group":"individual",n.querySelector("#d_course_name").innerText=e.course_name,n.querySelector("#d_instructor_name").innerText=e.instructor_name,n.querySelector("#d_location_name").innerText=e.location_name,n.querySelector("#d_slot_time").innerText=e.time_human_readable_sv,r.disabled=!1,e.is_cancelable?e.is_group&&n.querySelector("#deleteReservationWarning").classList.contains("d-none")&&(n.querySelector("#deleteReservationWarning").classList.remove("d-none"),n.querySelector("#deleteReservationWarning").classList.add("d-block")):(n.querySelector("#deleteReservationNotCancelable").classList.contains("d-none")&&(n.querySelector("#deleteReservationNotCancelable").classList.remove("d-none"),n.querySelector("#deleteReservationNotCancelable").classList.add("d-block")),r.disabled=!0)})}),t&&t.addEventListener("submit",function(e){var r=n.querySelector("#d_reservation_id").value;const t=n.querySelector("#d_reservation_type").value,o=n.querySelector("#d_course_name").innerText,s=n.querySelector("#deleteReservationSubmitButton"),l=s.querySelector("span.spinner-border");s.disabled=!0,l.classList.remove("d-none"),l.classList.add("d-inline-block"),fetch("/api/reservation/"+r,{method:"DELETE",headers:{"Content-Type":"application/json"}}).then(e=>e.text()).then(e=>{!1===JSON.parse(e).success?(n.querySelector("#deleteReservationError .alert span").innerText=JSON.parse(e).message,n.querySelector("#deleteReservationError").classList.remove("d-none"),n.querySelector("#deleteReservationError").classList.add("d-block"),s.disabled=!1):window.location.assign("/reservations?reservationDeleted=true"+("group"==t?"&reservationGroup=true":"")+"&reservationTitle="+o),l.classList.remove("d-inline-block"),l.classList.add("d-none")}).catch(e=>{n.querySelector("#deleteReservationError .alert span").innerText=e,n.querySelector("#deleteReservationError").classList.remove("d-none"),n.querySelector("#deleteReservationError").classList.add("d-block"),s.disabled=!1,l.classList.remove("d-inline-block"),l.classList.add("d-none")}),e.preventDefault(),e.stopPropagation()})});