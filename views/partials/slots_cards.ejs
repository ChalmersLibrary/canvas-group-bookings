<% if (session.user.isAdministrator || session.user.isInstructor) { %>
    <div class="row my-3">
        <div class="col">
            <button type="button" class="btn btn-md btn-secondary" data-bs-toggle="modal" data-bs-target="#newSlotSeries">Lägg till nya tider</button>
        </div>    
    </div>
<% } %>
<!--
<div class="card slots-filter">
    <div class="card-header">
        Filtrera
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <select id="slotFilterCourse" class="form-select form-select-sm" aria-label="Filtrera på tillfällen">
                    <option selected value="">Alla tillfällen</option>
                    <% courses.forEach((course) => { %>
                        <option value="<%= course.id %>"><%= course.name %></option>                                
                    <% }); %>
                </select>
            </div>
            <div class="col-md-3">
                <select id="slotFilterInstructor" class="form-select form-select-sm" aria-label="Filtrera på handledare">
                    <option selected value="">Alla handledare</option>
                    <% instructors.forEach((instructor) => { %>
                        <option value="<%= instructor.id %>"><%= instructor.name %></option>                                
                    <% }); %>
                </select>
            </div>
            <div class="col-md-3">
                <select id="slotFilterAvailability" class="form-select form-select-sm" aria-label="Filtrera på tillgänglighet">
                    <option value="1">Endast lediga tider</option>
                    <option selected value="2">Visa alla tider</option>
                </select>
            </div>
        </div>
    </div>
</div>
-->
<% if (segments && segments.length) { %>
    <ul class="nav nav-pills">
        <% segments.forEach(segment => { %>
            <li class="nav-item">
                <a class="nav-link <%= segment.active ? 'active' : '' %>" href="?segment=<%= segment.id %>"><%= segment.name %></a>
            </li>      
        <% }) %>
    </ul>
<% } %>
<% if (!slots.length) { %>
    <div class="alert alert-primary my-3" role="alert">
        <h4 class="alert-heading">Det finns inga tider att boka</h4>
        <p>Kika in igen senare eller vänta tills en handledare meddelar att nya tider finns att boka.</p>
    </div>
<% } else { %>
    <div class="d-flex align-content-start flex-wrap align-items-stretch">
        <% slots.forEach((slot) => { %>
            <div class="card m-2 rounded-0" style="min-width: 350px; max-width: 400px;" data-course_id="<%= slot.course_id %>" data-available="<%= slot.reservable_for_this_user %>">
                <div class="card-header">
                    <%= slot.course_name %>
                    <span class="badge bg-primary float-end rounded-0"><%= slot.course_segment_id %></span>
                </div>
                <div class="card-body">
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                          <i class="bi-calendar-event display-6"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <%- slot.time_human_readable_sv.split("kl")[0] %><br><%- slot.time_human_readable_sv.split("kl")[1] %>
                        </div>
                    </div>
                    <small class="text-muted"><%= slot.instructor_name %>, <%= slot.location_name %></small>
                    <div>
                        <small class="my-2">
                            <% if (slot.res_max == slot.res_now) { %>
                                Fullbokad, 
                            <% } else { %>
                                Tillgänglig, <%= slot.res_max-slot.res_now %> av 
                            <% } %>
                            <%= slot.res_max %>
                            <% if (slot.type == "group") { %>
                                <% if (slot.res_max > 1) { %>
                                    grupper
                                <% } else { %>
                                    grupp
                                <% } %>
                            <% } else { %>
                                personer
                            <% } %>
                        </small>
                    </div>
                    <small class="text-small text-muted"><%= slot.reservable_notice %></small>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-start align-items-start">
                        <% if (session.user.isAdministrator || session.user.isInstructor) { %>
                            <% if (session.user.isAdministrator || (session.user.isInstructor && session.user.db_id == slot.instructor_id)) { %>
                                <button type="button" title="Redigera" data-bs-toggle="modal" data-bs-target="#editSlot" data-bs-slot-id="<%= slot.id %>" class="btn btn-secondary btn-md"><i class="bi-pencil-fill"></i></button>
                                <button type="button" title="Radera" data-bs-toggle="modal" data-bs-target="#deleteSlot" data-bs-slot-id="<%= slot.id %>" class="btn btn-secondary btn-md mx-2"><i class="bi-trash-fill"></i></button>
                            <% } else { %>
                                <button disabled type="button" title="Redigera" class="btn btn-secondary btn-md"><i class="bi-pencil-fill"></i></button>
                                <button disabled type="button" title="Radera" class="btn btn-secondary btn-md mx-2"><i class="bi-trash-fill"></i></button>
                            <% } %>
                        <% } else { %>
                            <% if (slot.reservable_for_this_user) { %>
                                <button type="button" title="Boka tillfället" class="btn btn-primary btn-md" data-bs-toggle="modal" data-bs-target="#reserveSlot" data-bs-slot-id="<%= slot.id %>" >Boka</button>
                            <% } else { %>
                                <button type="button" title="Tillfället är inte bokningsbart" class="btn btn-secondary btn-md" disabled>Boka</button>
                            <% } %>
                        <% } %>
                    </div>
                </div>
            </div>
        <% }); %>
    </div>        
<% } %>

<% if (navigation.pages_total && navigation.pages_total > 1) { %>
    <nav aria-label="Page navigation">
        <ul class="pagination flex-wrap">
            <% if (navigation.current_page > 1) { %>
                <li class="page-item"><a class="page-link" href="?<%= navigation.link.previous_page %>">Föregående</a></li>
            <% } else { %>
                <li class="page-item disabled"><span class="page-link">Föregående</span></li>
            <% } %>
            <% navigation.pages.forEach(p => { %>
                <% if (p.current) { %>
                    <li class="page-item active"><span class="page-link"><%= p.page %></span></li>
                <% } else { %>
                    <li class="page-item"><a class="page-link" href="?<%= p.link %>"><%= p.page %></a></li>
                <% } %>
            <% }) %>
            <% if (navigation.current_page < navigation.pages_total) { %>
                <li class="page-item"><a class="page-link" href="?<%= navigation.link.next_page %>">Nästa</a></li>
            <% } else { %>
                <li class="page-item disabled"><span class="page-link">Nästa</span></li>
            <% } %>
        </ul>
    </nav>
<% } %>

<% if (session.user.isAdministrator || session.user.isInstructor) { %>
    <%- include('slots_admin_modal_new'); %>
    <%- include('slots_admin_modal_edit'); %>
    <%- include('slots_admin_modal_delete'); %>
<% } else { %>
    <%- include('reservations_public_modal_new'); %>
    <%- include('reservations_public_modal_delete'); %>
<% } %>
